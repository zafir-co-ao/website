name: Deploy Website

on:
    push:
        tags:
            - "*"

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set image metadata
              run: |
                  echo "IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/zafir-website:${GITHUB_REF_NAME}" >> $GITHUB_ENV
                  echo "HOME=/tmp" >> $GITHUB_ENV

            - name: Build container image
              run: docker build -t "$IMAGE" .

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Push image
              run: docker push "$IMAGE"

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                  token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Install kubectl
              uses: azure/setup-kubectl@v3
              with:
                  version: v1.29.2

            - name: Update deployment manifest
              run: sed -i "s|<IMAGE>|$IMAGE|" .deployments/k8s/deployment.yaml

            - name: Fetch kubeconfig
              run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 ${{ vars.DIGITALOCEAN_K8S_CLUSTER_NAME }}

            - name: Apply manifests
              run: kubectl apply -f .deployments/k8s/deployment.yaml

            - name: Verify rollout
              run: kubectl -n zafir rollout status deployment/zafir-website
